/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for personal finance data.
 * All data is nested under /users/{userId}, ensuring that users can only access their own information.
 *
 * Data Structure:
 * - /users/{userId}: User profile information.
 * - /users/{userId}/expenses/{expenseId}: Expense records.
 * - /users/{userId}/accounts/{accountId}: User's financial accounts.
 * - /users/{userId}/contributions/{contributionId}: Contribution records for shared expenses.
 * - /users/{userId}/categories/{categoryId}: User-defined expense categories.
 * - /users/{userId}/tags/{tagId}: User-defined tags for expenses.
 *
 * Key Security Decisions:
 * - User listing is disallowed.
 * - Only authenticated users can access data.
 * - All write operations are restricted to the owner of the data.
 *
 * Denormalization for Authorization:
 *  User Id is present on every document to avoid needing to call get().
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure user profiles. Only the owner can read and write their profile.
     * @path /users/{userId}
     * @allow (create) - Authenticated user creating their own profile.
     *   Request: auth.uid = "user123", resource.data.id = "user123"
     * @allow (get, update, delete) - Authenticated user accessing their own profile.
     *   Request: auth.uid = "user123", path = "/users/user123"
     * @deny (get, update, delete) - Authenticated user trying to access another user's profile.
     *   Request: auth.uid = "user123", path = "/users/user456"
     * @principle Enforces document ownership and prevents unauthorized access to user profiles.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secure expenses for a user. Only the owner can read and write their expenses.
     * @path /users/{userId}/expenses/{expenseId}
     * @allow (create) - Authenticated user creating an expense for themselves.
     *   Request: auth.uid = "user123", resource.data.userId = "user123"
     * @allow (get, update, delete) - Authenticated user accessing their own expense.
     *   Request: auth.uid = "user123", path = "/users/user123/expenses/expense456"
     * @deny (get, update, delete) - Authenticated user trying to access another user's expense.
     *   Request: auth.uid = "user123", path = "/users/user456/expenses/expense789"
     * @principle Enforces document ownership and prevents unauthorized access to expenses.
     */
    match /users/{userId}/expenses/{expenseId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secure accounts for a user. Only the owner can read and write their accounts.
     * @path /users/{userId}/accounts/{accountId}
     * @allow (create) - Authenticated user creating an account for themselves.
     *   Request: auth.uid = "user123", resource.data.userId = "user123"
     * @allow (get, update, delete) - Authenticated user accessing their own account.
     *   Request: auth.uid = "user123", path = "/users/user123/accounts/account456"
     * @deny (get, update, delete) - Authenticated user trying to access another user's account.
     *   Request: auth.uid = "user123", path = "/users/user456/accounts/account789"
     * @principle Enforces document ownership and prevents unauthorized access to accounts.
     */
    match /users/{userId}/accounts/{accountId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secure contributions for a user. Only the owner can read and write their contributions.
     * @path /users/{userId}/contributions/{contributionId}
     * @allow (create) - Authenticated user creating a contribution for themselves.
     *   Request: auth.uid = "user123", resource.data.userId = "user123"
     * @allow (get, update, delete) - Authenticated user accessing their own contribution.
     *   Request: auth.uid = "user123", path = "/users/user123/contributions/contribution456"
     * @deny (get, update, delete) - Authenticated user trying to access another user's contribution.
     *   Request: auth.uid = "user123", path = "/users/user456/contributions/contribution789"
     * @principle Enforces document ownership and prevents unauthorized access to contributions.
     */
    match /users/{userId}/contributions/{contributionId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secure categories for a user. Only the owner can read and write their categories.
     * @path /users/{userId}/categories/{categoryId}
     * @allow (create) - Authenticated user creating a category for themselves.
     *   Request: auth.uid = "user123", resource.data.userId = "user123"
     * @allow (get, update, delete) - Authenticated user accessing their own category.
     *   Request: auth.uid = "user123", path = "/users/user123/categories/category456"
     * @deny (get, update, delete) - Authenticated user trying to access another user's category.
     *   Request: auth.uid = "user123", path = "/users/user456/categories/category789"
     * @principle Enforces document ownership and prevents unauthorized access to categories.
     */
    match /users/{userId}/categories/{categoryId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secure tags for a user. Only the owner can read and write their tags.
     * @path /users/{userId}/tags/{tagId}
     * @allow (create) - Authenticated user creating a tag for themselves.
     *   Request: auth.uid = "user123", resource.data.userId = "user123"
     * @allow (get, update, delete) - Authenticated user accessing their own tag.
     *   Request: auth.uid = "user123", path = "/users/user123/tags/tag456"
     * @deny (get, update, delete) - Authenticated user trying to access another user's tag.
     *   Request: auth.uid = "user123", path = "/users/user456/tags/tag789"
     * @principle Enforces document ownership and prevents unauthorized access to tags.
     */
    match /users/{userId}/tags/{tagId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }
  }
}