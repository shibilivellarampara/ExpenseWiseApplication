rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Authentication required for all protected resources.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the resource.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle User ownership is enforced for all resources.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the owner of the resource and the resource exists.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Prevents updates and deletes on non-existent documents.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && exists(resource);
    }

    /**
     * @description Enforces that on a create operation, the resource's userId field matches the userId in the path.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Ensures data integrity and prevents unauthorized data creation.
     */
    function isCreatingWithOwnerId(userId) {
        return request.resource.data.userId == userId;
    }

    /**
     * @description Enforces that an update operation cannot change the userId field.
     * @path N/A
     * @allow N/A
     * @deny N/A
     * @principle Ensures data integrity by preventing unauthorized modification of user relationships.
     */
    function isOwnerIdImmutable(userId) {
        return resource.data.userId == request.resource.data.userId;
    }

    /**
     * @description Rules for user profiles.
     * @path /users/{userId}
     * @allow (create) If the authenticated user's ID matches the userId.
     * @deny (create) If the authenticated user's ID does not match the userId.
     * @allow (get) If the authenticated user's ID matches the userId.
     * @deny (get) If the authenticated user's ID does not match the userId.
     * @allow (update) If the authenticated user's ID matches the userId and the user profile exists.
     * @deny (update) If the authenticated user's ID does not match the userId or the user profile does not exist.
     * @allow (delete) If the authenticated user's ID matches the userId and the user profile exists.
     * @deny (delete) If the authenticated user's ID does not match the userId or the user profile does not exist.
     * @principle Enforces user ownership for profile management.
     */
    match /users/{userId} {
      allow create: if isOwner(userId);
      allow get: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
      allow list: if false; // User listing is not permitted
    }

    /**
     * @description Rules for expenses under a user.
     * @path /users/{userId}/expenses/{expenseId}
     * @allow (create) If the authenticated user is the owner and the expense's userId matches the path's userId.
     * @deny (create) If the authenticated user is not the owner or the expense's userId does not match the path's userId.
     * @allow (get) If the authenticated user is the owner.
     * @deny (get) If the authenticated user is not the owner.
     * @allow (update) If the authenticated user is the owner, the expense exists, and the userId field is immutable.
     * @deny (update) If the authenticated user is not the owner, the expense does not exist, or the userId field is changed.
     * @allow (delete) If the authenticated user is the owner and the expense exists.
     * @deny (delete) If the authenticated user is not the owner or the expense does not exist.
     * @principle Enforces user ownership for expense management.
     */
    match /users/{userId}/expenses/{expenseId} {
      allow create: if isOwner(userId); // && isCreatingWithOwnerId(userId);  Data shape is flexible in Prototyping Mode
      allow get: if isOwner(userId);
      allow update: if isExistingOwner(userId) && getResource(resource).data.userId == request.resource.data.userId;
      allow delete: if isExistingOwner(userId);
      allow list: if isOwner(userId);
    }

    /**
     * @description Rules for accounts under a user.
     * @path /users/{userId}/accounts/{accountId}
     * @allow (create) If the authenticated user is the owner and the account's userId matches the path's userId.
     * @deny (create) If the authenticated user is not the owner or the account's userId does not match the path's userId.
     * @allow (get) If the authenticated user is the owner.
     * @deny (get) If the authenticated user is not the owner.
     * @allow (update) If the authenticated user is the owner, the account exists, and the userId field is immutable.
     * @deny (update) If the authenticated user is not the owner, the account does not exist, or the userId field is changed.
     * @allow (delete) If the authenticated user is the owner and the account exists.
     * @deny (delete) If the authenticated user is not the owner or the account does not exist.
     * @principle Enforces user ownership for account management.
     */
    match /users/{userId}/accounts/{accountId} {
      allow create: if isOwner(userId); // && isCreatingWithOwnerId(userId);  Data shape is flexible in Prototyping Mode
      allow get: if isOwner(userId);
      allow update: if isExistingOwner(userId) && getResource(resource).data.userId == request.resource.data.userId;
      allow delete: if isExistingOwner(userId);
      allow list: if isOwner(userId);
    }

    /**
     * @description Rules for contributions under a user.
     * @path /users/{userId}/contributions/{contributionId}
     * @allow (create) If the authenticated user is the owner and the contribution's userId matches the path's userId.
     * @deny (create) If the authenticated user is not the owner or the contribution's userId does not match the path's userId.
     * @allow (get) If the authenticated user is the owner.
     * @deny (get) If the authenticated user is not the owner.
     * @allow (update) If the authenticated user is the owner, the contribution exists, and the userId field is immutable.
     * @deny (update) If the authenticated user is not the owner, the contribution does not exist, or the userId field is changed.
     * @allow (delete) If the authenticated user is the owner and the contribution exists.
     * @deny (delete) If the authenticated user is not the owner or the contribution does not exist.
     * @principle Enforces user ownership for contribution management.
     */
    match /users/{userId}/contributions/{contributionId} {
      allow create: if isOwner(userId); // && isCreatingWithOwnerId(userId);  Data shape is flexible in Prototyping Mode
      allow get: if isOwner(userId);
      allow update: if isExistingOwner(userId) && getResource(resource).data.userId == request.resource.data.userId;
      allow delete: if isExistingOwner(userId);
      allow list: if isOwner(userId);
    }

    /**
     * @description Rules for categories under a user.
     * @path /users/{userId}/categories/{categoryId}
     * @allow (create) If the authenticated user is the owner and the category's userId matches the path's userId.
     * @deny (create) If the authenticated user is not the owner or the category's userId does not match the path's userId.
     * @allow (get) If the authenticated user is the owner.
     * @deny (get) If the authenticated user is not the owner.
     * @allow (update) If the authenticated user is the owner, the category exists, and the userId field is immutable.
     * @deny (update) If the authenticated user is not the owner, the category does not exist, or the userId field is changed.
     * @allow (delete) If the authenticated user is the owner and the category exists.
     * @deny (delete) If the authenticated user is not the owner or the category does not exist.
     * @principle Enforces user ownership for category management.
     */
    match /users/{userId}/categories/{categoryId} {
      allow create: if isOwner(userId); // && isCreatingWithOwnerId(userId);  Data shape is flexible in Prototyping Mode
      allow get: if isOwner(userId);
      allow update: if isExistingOwner(userId) && getResource(resource).data.userId == request.resource.data.userId;
      allow delete: if isExistingOwner(userId);
      allow list: if isOwner(userId);
    }

    /**
     * @description Rules for tags under a user.
     * @path /users/{userId}/tags/{tagId}
     * @allow (create) If the authenticated user is the owner and the tag's userId matches the path's userId.
     * @deny (create) If the authenticated user is not the owner or the tag's userId does not match the path's userId.
     * @allow (get) If the authenticated user is the owner.
     * @deny (get) If the authenticated user is not the owner.
     * @allow (update) If the authenticated user is the owner, the tag exists, and the userId field is immutable.
     * @deny (update) If the authenticated user is not the owner, the tag does not exist, or the userId field is changed.
     * @allow (delete) If the authenticated user is the owner and the tag exists.
     * @deny (delete) If the authenticated user is not the owner or the tag does not exist.
     * @principle Enforces user ownership for tag management.
     */
    match /users/{userId}/tags/{tagId} {
      allow create: if isOwner(userId); // && isCreatingWithOwnerId(userId);  Data shape is flexible in Prototyping Mode
      allow get: if isOwner(userId);
      allow update: if isExistingOwner(userId) && getResource(resource).data.userId == request.resource.data.userId;
      allow delete: if isExistingOwner(userId);
      allow list: if isOwner(userId);
    }
  }
}