rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    /**
     * @description This ruleset enforces a strict user-ownership model for most data,
     *              allowing users to manage their own profiles, expenses, accounts,
     *              contributions, categories, and tags. Shared expenses introduce
     *              collaborative access via a member list.
     * @dataStructure
     *              - /users/{userId}: User profile information.
     *              - /users/{userId}/expenses/{expenseId}: User's expense records.
     *              - /users/{userId}/accounts/{accountId}: User's financial accounts.
     *              - /users/{userId}/contributions/{contributionId}: User's contributions to shared expenses.
     *              - /users/{userId}/categories/{categoryId}: User's expense categories.
     *              - /users/{userId}/tags/{tagId}: User's expense tags.
     *              - /shared_expenses/{sharedExpenseId}: Shared expense documents with a list of member IDs.
     * @keySecurityDecisions
     *              - User listing is disallowed.
     *              - Default security posture for ambiguous relationships is strict owner-only access.
     *              - Shared expenses use a "Shared Access (Closed Collaborators)" pattern, with access
     *                granted to users listed in the `memberIds` array.
     * @denormalizationForAuthorization
     *              - Shared expenses denormalize the list of authorized user IDs (`memberIds`) directly
     *                onto the document. This avoids costly `get()` operations to a separate
     *                membership collection.
     * @structuralSegregation
     *              - User-specific data (expenses, accounts, etc.) is stored in subcollections
     *                under the `/users/{userId}` path, ensuring private access by default.
     */

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Manages access to user profiles. Allows a user to create their own profile and restricts
     *              updates and deletes to the profile owner.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their profile.
     */
    match /users/{userId} {
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow read: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);

      match /expenses/{expenseId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }

      match /accounts/{accountId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }

      match /contributions/{contributionId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }

      match /categories/{categoryId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }

      match /tags/{tagId} {
        allow read: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }
    }

    match /shared_expenses/{sharedExpenseId} {
      allow read: if isSignedIn() && 'memberIds' in resource.data && resource.data.memberIds is list && request.auth.uid in resource.data.memberIds;
      allow create: if isSignedIn() && request.resource.data.memberIds is list && request.resource.data.memberIds.size() > 0 && request.auth.uid in request.resource.data.memberIds;
      allow update: if isSignedIn() && 'memberIds' in resource.data && resource.data.memberIds is list && request.auth.uid in resource.data.memberIds;
      allow delete: if isSignedIn() && 'memberIds' in resource.data && resource.data.memberIds is list && request.auth.uid in resource.data.memberIds;
    }
  }
}