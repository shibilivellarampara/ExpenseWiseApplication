/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for all data.
 *
 * Data Structure:
 * All data is nested under /users/{userId}, ensuring that each user has a private data tree.
 *  - /users/{userId}: Stores user profile information.
 *  - /users/{userId}/expenses/{expenseId}: Stores individual expense records.
 *  - /users/{userId}/accounts/{accountId}: Stores user's financial account information.
 *  - /users/{userId}/contributions/{contributionId}: Stores contribution records for shared expenses.
 *  - /users/{userId}/categories/{categoryId}: Stores user-defined expense categories.
 *  - /users/{userId}/tags/{tagId}: Stores user-defined tags for expenses.
 *
 * Key Security Decisions:
 * - User profiles can only be created by the user themselves upon initial sign-up.
 * - Listing of users is explicitly denied.
 * - All subcollections under a user's path are only accessible to that user.
 * - Data consistency is enforced between the path and the document's internal userId field on creation and update.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user ID matches the provided user ID.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user is the owner of the existing document.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Enforces that a field cannot be changed after creation.
     */
    function isImmutable(field) {
      return resource.data[field] == request.resource.data[field];
    }

    /**
     * @description Rules for user profiles.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' creates their profile.
     * @deny (create) User with ID 'user123' attempts to create profile for 'otherUser'.
     * @allow (get) User with ID 'user123' retrieves their profile.
     * @deny (get) User with ID 'user123' attempts to retrieve profile for 'otherUser'.
     * @allow (update) User with ID 'user123' updates their own profile.
     * @deny (update) User with ID 'user123' attempts to update profile for 'otherUser'.
     * @allow (delete) User with ID 'user123' deletes their own profile.
     * @deny (delete) User with ID 'user123' attempts to delete profile for 'otherUser'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Listing users is not permitted.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && isImmutable('id');
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for expenses.
     * @path /users/{userId}/expenses/{expenseId}
     * @allow (create) User with ID 'user123' creates an expense.
     * @deny (create) User with ID 'user123' attempts to create expense for 'otherUser'.
     * @allow (get) User with ID 'user123' retrieves their own expense.
     * @deny (get) User with ID 'user123' attempts to retrieve an expense for 'otherUser'.
     * @allow (update) User with ID 'user123' updates their own expense.
     * @deny (update) User with ID 'user123' attempts to update expense for 'otherUser'.
     * @allow (delete) User with ID 'user123' deletes their own expense.
     * @deny (delete) User with ID 'user123' attempts to delete expense for 'otherUser'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/expenses/{expenseId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId && request.resource.data.id == expenseId;
      allow update: if isExistingOwner(userId) && isImmutable('userId');
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for accounts.
     * @path /users/{userId}/accounts/{accountId}
     * @allow (create) User with ID 'user123' creates an account.
     * @deny (create) User with ID 'user123' attempts to create account for 'otherUser'.
     * @allow (get) User with ID 'user123' retrieves their own account.
     * @deny (get) User with ID 'user123' attempts to retrieve an account for 'otherUser'.
     * @allow (update) User with ID 'user123' updates their own account.
     * @deny (update) User with ID 'user123' attempts to update account for 'otherUser'.
     * @allow (delete) User with ID 'user123' deletes their own account.
     * @deny (delete) User with ID 'user123' attempts to delete account for 'otherUser'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/accounts/{accountId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId && request.resource.data.id == accountId;
      allow update: if isExistingOwner(userId) && isImmutable('userId');
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for contributions.
     * @path /users/{userId}/contributions/{contributionId}
     * @allow (create) User with ID 'user123' creates a contribution.
     * @deny (create) User with ID 'user123' attempts to create contribution for 'otherUser'.
     * @allow (get) User with ID 'user123' retrieves their own contribution.
     * @deny (get) User with ID 'user123' attempts to retrieve a contribution for 'otherUser'.
     * @allow (update) User with ID 'user123' updates their own contribution.
     * @deny (update) User with ID 'user123' attempts to update contribution for 'otherUser'.
     * @allow (delete) User with ID 'user123' deletes their own contribution.
     * @deny (delete) User with ID 'user123' attempts to delete contribution for 'otherUser'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/contributions/{contributionId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId && request.resource.data.id == contributionId;
      allow update: if isExistingOwner(userId) && isImmutable('userId');
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for categories.
     * @path /users/{userId}/categories/{categoryId}
     * @allow (create) User with ID 'user123' creates a category.
     * @deny (create) User with ID 'user123' attempts to create category for 'otherUser'.
     * @allow (get) User with ID 'user123' retrieves their own category.
     * @deny (get) User with ID 'user123' attempts to retrieve a category for 'otherUser'.
     * @allow (update) User with ID 'user123' updates their own category.
     * @deny (update) User with ID 'user123' attempts to update category for 'otherUser'.
     * @allow (delete) User with ID 'user123' deletes their own category.
     * @deny (delete) User with ID 'user123' attempts to delete category for 'otherUser'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/categories/{categoryId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId && request.resource.data.id == categoryId;
      allow update: if isExistingOwner(userId) && isImmutable('userId');
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for tags.
     * @path /users/{userId}/tags/{tagId}
     * @allow (create) User with ID 'user123' creates a tag.
     * @deny (create) User with ID 'user123' attempts to create tag for 'otherUser'.
     * @allow (get) User with ID 'user123' retrieves their own tag.
     * @deny (get) User with ID 'user123' attempts to retrieve a tag for 'otherUser'.
     * @allow (update) User with ID 'user123' updates their own tag.
     * @deny (update) User with ID 'user123' attempts to update tag for 'otherUser'.
     * @allow (delete) User with ID 'user123' deletes their own tag.
     * @deny (delete) User with ID 'user123' attempts to delete tag for 'otherUser'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/tags/{tagId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId && request.resource.data.id == tagId;
      allow update: if isExistingOwner(userId) && isImmutable('userId');
      allow delete: if isExistingOwner(userId);
    }
  }
}