/**
 * @description
 * This ruleset enforces a strict user-ownership model for all data stored under the /users/{userId} path,
 * and defines controlled access for shared expenses.
 *
 * Structure:
 * - /users/{userId} → private user tree (accounts, categories, tags, etc.)
 * - /shared_expenses/{expenseId} → shared group-level expense
 * - /shared_expenses/{expenseId}/expenses/{subExpenseId} → individual expense items within a shared expense
 *
 * Key Decisions:
 * - Users can only access their own /users/{userId} data.
 * - Shared expenses are publicly readable, authenticated users can modify.
 * - Nested shared expense items are also publicly readable, authenticated users can modify.
 */

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------- Shared Expenses (Top Level) -----------
    match /shared_expenses/{expenseId} {
      allow get, list: if true;
      allow create, update, delete: if isSignedIn();

      // ----------- Nested Subcollection: expenses -----------
      match /expenses/{subExpenseId} {
        allow get, list: if true;
        allow create, update, delete: if isSignedIn();
      }
    }

    // ----------- Collection Group Fallback -----------
    match /shared_expenses/{expenseId}/expenses/{subExpenseId=**} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    // ----------- Private User Data -----------
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);

      match /expenses/{expenseId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
      }

      match /accounts/{accountId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
      }

      match /contributions/{contributionId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
      }

      match /categories/{categoryId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
      }

      match /tags/{tagId} {
        allow get, list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
      }
    }
  }

  // ----------- Helper Functions -----------
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return request.auth != null && request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}

