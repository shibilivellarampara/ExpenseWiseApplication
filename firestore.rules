/**
 * @fileoverview Firestore Security Rules for the Expense Tracker application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. Each user has a dedicated
 * data tree under `/users/{userId}` where they can store their profile,
 * expenses, accounts, categories, and tags.  Only the authenticated user can
 * read and write data to their own data tree.
 *
 * Data Structure:
 * - /users/{userId}: User profile data.
 * - /users/{userId}/expenses/{expenseId}: Expense records for a specific user.
 * - /users/{userId}/accounts/{accountId}: Financial account information for a user.
 * - /users/{userId}/contributions/{contributionId}: Contribution records for shared expenses for a user.
 * - /users/{userId}/categories/{categoryId}: Expense categories defined by the user.
 * - /users/{userId}/tags/{tagId}: Expense tags defined by the user.
 *
 * Key Security Decisions:
 * - User listing is explicitly denied.
 * - All data is private and user-specific, so there are no public collections.
 * - All write operations are validated against the authenticated user's ID.
 * - No schema validation is performed beyond checking user IDs for ownership.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' can create their profile.
     * @allow (get) User with ID 'user123' can read their profile.
     * @allow (update) User with ID 'user123' can update their profile.
     * @allow (delete) User with ID 'user123' can delete their profile.
     * @deny (create) User with ID 'user456' cannot create a profile for 'user123'.
     * @deny (get) User with ID 'user456' cannot read the profile of 'user123'.
     * @deny (update) User with ID 'user456' cannot update the profile of 'user123'.
     * @deny (delete) User with ID 'user456' cannot delete the profile of 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to expense documents.
     * @path /users/{userId}/expenses/{expenseId}
     * @allow (create) User with ID 'user123' can create an expense record.
     * @allow (get) User with ID 'user123' can read their expense record.
     * @allow (update) User with ID 'user123' can update their expense record.
     * @allow (delete) User with ID 'user123' can delete their expense record.
     * @deny (create) User with ID 'user456' cannot create an expense for 'user123'.
     * @deny (get) User with ID 'user456' cannot read the expense of 'user123'.
     * @deny (update) User with ID 'user456' cannot update the expense of 'user123'.
     * @deny (delete) User with ID 'user456' cannot delete the expense of 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/expenses/{expenseId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to account documents.
     * @path /users/{userId}/accounts/{accountId}
     * @allow (create) User with ID 'user123' can create an account.
     * @allow (get) User with ID 'user123' can read their account details.
     * @allow (update) User with ID 'user123' can update their account details.
     * @allow (delete) User with ID 'user123' can delete their account.
     * @deny (create) User with ID 'user456' cannot create an account for 'user123'.
     * @deny (get) User with ID 'user456' cannot read the account of 'user123'.
     * @deny (update) User with ID 'user456' cannot update the account of 'user123'.
     * @deny (delete) User with ID 'user456' cannot delete the account of 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/accounts/{accountId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to contribution documents.
     * @path /users/{userId}/contributions/{contributionId}
     * @allow (create) User with ID 'user123' can create a contribution record.
     * @allow (get) User with ID 'user123' can read their contribution record.
     * @allow (update) User with ID 'user123' can update their contribution record.
     * @allow (delete) User with ID 'user123' can delete their contribution record.
     * @deny (create) User with ID 'user456' cannot create a contribution for 'user123'.
     * @deny (get) User with ID 'user456' cannot read the contribution of 'user123'.
     * @deny (update) User with ID 'user456' cannot update the contribution of 'user123'.
     * @deny (delete) User with ID 'user456' cannot delete the contribution of 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/contributions/{contributionId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to category documents.
     * @path /users/{userId}/categories/{categoryId}
     * @allow (create) User with ID 'user123' can create a category.
     * @allow (get) User with ID 'user123' can read their category details.
     * @allow (update) User with ID 'user123' can update their category details.
     * @allow (delete) User with ID 'user123' can delete their category.
     * @deny (create) User with ID 'user456' cannot create a category for 'user123'.
     * @deny (get) User with ID 'user456' cannot read the category of 'user123'.
     * @deny (update) User with ID 'user456' cannot update the category of 'user123'.
     * @deny (delete) User with ID 'user456' cannot delete the category of 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/categories/{categoryId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to tag documents.
     * @path /users/{userId}/tags/{tagId}
     * @allow (create) User with ID 'user123' can create a tag.
     * @allow (get) User with ID 'user123' can read their tag details.
     * @allow (update) User with ID 'user123' can update their tag details.
     * @allow (delete) User with ID 'user123' can delete their tag.
     * @deny (create) User with ID 'user456' cannot create a tag for 'user123'.
     * @deny (get) User with ID 'user456' cannot read the tag of 'user123'.
     * @deny (update) User with ID 'user456' cannot update the tag of 'user123'.
     * @deny (delete) User with ID 'user456' cannot delete the tag of 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/tags/{tagId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }
  }

  // Helper function to determine if the request is from the owner.
  function isOwner(userId) {
    return isSignedIn() && request.auth.uid == userId;
  }

  // Helper function to determine if the request is from the owner and the resource exists
  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }

  // Helper function to determine if a user is signed in
  function isSignedIn() {
    return request.auth != null;
  }
}