/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for all data.
 * All data is nested under /users/{userId}, ensuring that users can only access their own data.
 *
 * Data Structure:
 * - /users/{userId}: User profile information.
 * - /users/{userId}/expenses/{expenseId}: Expense records.
 * - /users/{userId}/accounts/{accountId}: User's financial accounts.
 * - /users/{userId}/contributions/{contributionId}: Contribution records for shared expenses.
 * - /users/{userId}/categories/{categoryId}: User-defined expense categories.
 * - /users/{userId}/tags/{tagId}: User-defined tags for expenses.
 *
 * Key Security Decisions:
 * - User listing is disallowed.
 * - All write operations require the user to be authenticated.
 * - All write operations are restricted to the owner of the data.
 * - All data is private to the user and not publicly accessible.
 *
 * Denormalization for Authorization:
 *  To create simpler, more performant rules, always denormalize (copy) data required for an authorization decision directly onto the documents being secured. This avoids slow, costly, or impossible security checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure user profiles. Only the authenticated user can read/write their own profile.
     * @path /users/{userId}
     * @allow (create) User with UID 'user_abc' creates their profile.
     * @allow (get) User with UID 'user_abc' reads their profile.
     * @allow (update) User with UID 'user_abc' updates their profile.
     * @allow (delete) User with UID 'user_abc' deletes their profile.
     * @deny (create) User with UID 'user_xyz' attempts to create a profile for user 'user_abc'.
     * @deny (get) User with UID 'user_xyz' attempts to read the profile of user 'user_abc'.
     * @deny (update) User with UID 'user_xyz' attempts to update the profile of user 'user_abc'.
     * @deny (delete) User with UID 'user_xyz' attempts to delete the profile of user 'user_abc'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secure expense records under a user's profile. Only the owner user can manage their expenses.
     * @path /users/{userId}/expenses/{expenseId}
     * @allow (create) User with UID 'user_abc' creates an expense record under their profile.
     * @allow (get) User with UID 'user_abc' reads an expense record under their profile.
     * @allow (update) User with UID 'user_abc' updates an expense record under their profile.
     * @allow (delete) User with UID 'user_abc' deletes an expense record under their profile.
     * @deny (create) User with UID 'user_xyz' attempts to create an expense record under user 'user_abc' profile.
     * @deny (get) User with UID 'user_xyz' attempts to read an expense record under user 'user_abc' profile.
     * @deny (update) User with UID 'user_xyz' attempts to update an expense record under user 'user_abc' profile.
     * @deny (delete) User with UID 'user_xyz' attempts to delete an expense record under user 'user_abc' profile.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/expenses/{expenseId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secure account records under a user's profile. Only the owner user can manage their accounts.
     * @path /users/{userId}/accounts/{accountId}
     * @allow (create) User with UID 'user_abc' creates an account record under their profile.
     * @allow (get) User with UID 'user_abc' reads an account record under their profile.
     * @allow (update) User with UID 'user_abc' updates an account record under their profile.
     * @allow (delete) User with UID 'user_abc' deletes an account record under their profile.
     * @deny (create) User with UID 'user_xyz' attempts to create an account record under user 'user_abc' profile.
     * @deny (get) User with UID 'user_xyz' attempts to read an account record under user 'user_abc' profile.
     * @deny (update) User with UID 'user_xyz' attempts to update an account record under user 'user_abc' profile.
     * @deny (delete) User with UID 'user_xyz' attempts to delete an account record under user 'user_abc' profile.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/accounts/{accountId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secure contribution records under a user's profile. Only the owner user can manage their contributions.
     * @path /users/{userId}/contributions/{contributionId}
     * @allow (create) User with UID 'user_abc' creates a contribution record under their profile.
     * @allow (get) User with UID 'user_abc' reads a contribution record under their profile.
     * @allow (update) User with UID 'user_abc' updates a contribution record under their profile.
     * @allow (delete) User with UID 'user_abc' deletes a contribution record under their profile.
     * @deny (create) User with UID 'user_xyz' attempts to create a contribution record under user 'user_abc' profile.
     * @deny (get) User with UID 'user_xyz' attempts to read a contribution record under user 'user_abc' profile.
     * @deny (update) User with UID 'user_xyz' attempts to update a contribution record under user 'user_abc' profile.
     * @deny (delete) User with UID 'user_xyz' attempts to delete a contribution record under user 'user_abc' profile.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/contributions/{contributionId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secure category records under a user's profile. Only the owner user can manage their categories.
     * @path /users/{userId}/categories/{categoryId}
     * @allow (create) User with UID 'user_abc' creates a category record under their profile.
     * @allow (get) User with UID 'user_abc' reads a category record under their profile.
     * @allow (update) User with UID 'user_abc' updates a category record under their profile.
     * @allow (delete) User with UID 'user_abc' deletes a category record under their profile.
     * @deny (create) User with UID 'user_xyz' attempts to create a category record under user 'user_abc' profile.
     * @deny (get) User with UID 'user_xyz' attempts to read a category record under user 'user_abc' profile.
     * @deny (update) User with UID 'user_xyz' attempts to update a category record under user 'user_abc' profile.
     * @deny (delete) User with UID 'user_xyz' attempts to delete a category record under user 'user_abc' profile.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/categories/{categoryId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secure tag records under a user's profile. Only the owner user can manage their tags.
     * @path /users/{userId}/tags/{tagId}
     * @allow (create) User with UID 'user_abc' creates a tag record under their profile.
     * @allow (get) User with UID 'user_abc' reads a tag record under their profile.
     * @allow (update) User with UID 'user_abc' updates a tag record under their profile.
     * @allow (delete) User with UID 'user_abc' deletes a tag record under their profile.
     * @deny (create) User with UID 'user_xyz' attempts to create a tag record under user 'user_abc' profile.
     * @deny (get) User with UID 'user_xyz' attempts to read a tag record under user 'user_abc' profile.
     * @deny (update) User with UID 'user_xyz' attempts to update a tag record under user 'user_abc' profile.
     * @deny (delete) User with UID 'user_xyz' attempts to delete a tag record under user 'user_abc' profile.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/tags/{tagId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }
  }
}