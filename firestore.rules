/**
 * @fileoverview Firestore Security Rules for the Expense Tracker application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. Each user has full control
 * over their own data, which is stored under their respective user ID. No data is
 * shared between users unless explicitly designed so via a Shared Access pattern.
 *
 * Data Structure:
 * All data is nested under /users/{userId}, ensuring data isolation.
 *  - /users/{userId} (UserProfile)
 *  - /users/{userId}/expenses/{expenseId} (Expense)
 *  - /users/{userId}/accounts/{accountId} (Account)
 *  - /users/{userId}/contributions/{contributionId} (Contribution)
 *  - /users/{userId}/categories/{categoryId} (Category)
 *  - /users/{userId}/tags/{tagId} (Tag)
 *
 * Key Security Decisions:
 * - User listing is disallowed to protect privacy.
 * - All write operations are validated against the authenticated user's ID.
 * - No schema validation is performed beyond authorization-critical fields, to allow for rapid prototyping.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to UserProfile documents.
     * @path /users/{userId}
     * @allow (create) User with matching UID can create their profile.
     * @allow (get, update, delete) User with matching UID can access and modify their profile.
     * @deny (list) User listing is not allowed.
     * @deny (create) User cannot create profile with non-matching UID.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to Expense documents.
     * @path /users/{userId}/expenses/{expenseId}
     * @allow (create, get, update, delete, list) User with matching UID can manage their expenses.
     * @deny User cannot access or modify expenses of other users.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/expenses/{expenseId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to Account documents.
     * @path /users/{userId}/accounts/{accountId}
     * @allow (create, get, update, delete, list) User with matching UID can manage their accounts.
     * @deny User cannot access or modify accounts of other users.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/accounts/{accountId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to Contribution documents.
     * @path /users/{userId}/contributions/{contributionId}
     * @allow (create, get, update, delete, list) User with matching UID can manage their contributions.
     * @deny User cannot access or modify contributions of other users.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/contributions/{contributionId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to Category documents.
     * @path /users/{userId}/categories/{categoryId}
     * @allow (create, get, update, delete, list) User with matching UID can manage their categories.
     * @deny User cannot access or modify categories of other users.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/categories/{categoryId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to Tag documents.
     * @path /users/{userId}/tags/{tagId}
     * @allow (create, get, update, delete, list) User with matching UID can manage their tags.
     * @deny User cannot access or modify tags of other users.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/tags/{tagId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
          return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }
  }
}